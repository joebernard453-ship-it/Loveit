<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lovit Social</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .navbar { display: flex; justify-content: space-around; padding-bottom: 20px; }
        .navbar a { color: #00ddff; text-decoration: none; font-weight: bold; }
        .post-card { background: #1f1f1f; margin: 15px 0; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        .btn { background: #00ddff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; margin-top: 10px; }
        .video-post { border-bottom: 1px solid #444; padding: 15px 0; }
    </style>
</head>
<body>
    <nav class="navbar"><a href="#">Home</a><a href="#">Profile</a></nav>
    <h1>Lovit Social</h1>

    <div class="post-card">
        <h3>Share a Video</h3>
        <input type="file" id="videoInput" accept="video/*">
        <input type="text" id="captionInput" placeholder="Write a caption..." style="width: 100%; margin-top:10px; background:#333; color:white; border:none; padding:10px;">
        <button class="btn" onclick="uploadToDatabase()">Post to Lovit</button>
        <p id="statusText" style="color: #00ddff;"></p>
    </div>

    <h2>Recent Posts</h2>
    <div id="videoFeed">Loading posts...</div>

    <script>
        // A. Load Feed from Database
        async function loadFeed() {
            const feed = document.getElementById('videoFeed');
            try {
                const response = await fetch('/posts');
                const posts = await response.json();
                feed.innerHTML = posts.map(post => `
                    <div class="video-post">
                        <video src="${post.video_url}" controls width="100%" style="border-radius:10px;"></video>
                        <p><b>Caption:</b> ${post.caption}</p>
                        <small>${new Date(post.created_at).toLocaleString()}</small>
                    </div>
                `).join('');
            } catch (err) {
                feed.innerText = "Error loading feed.";
            }
        }

        // B. Upload to Cloudinary & Save to Postgres
        async function uploadToDatabase() {
            const fileInput = document.getElementById('videoInput');
            const captionInput = document.getElementById('captionInput');
            const status = document.getElementById('statusText');

            if (!fileInput.files[0]) return alert("Select a video!");

            status.innerText = "Uploading to Cloud... please wait.";
            const formData = new FormData();
            formData.append('video', fileInput.files[0]);
            formData.append('caption', captionInput.value);

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                status.innerText = "Shared successfully!";
                loadFeed(); // Refresh feed automatically
            } else {
                status.innerText = "Upload failed.";
            }
        }

        // Initialize Feed on load
        loadFeed();
    </script>
</body>
</html>
